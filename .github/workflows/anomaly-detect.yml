name: ğŸ” Anomaly Detection

on:
  push:
    paths:
      - '**.csv'
      - 'detect.py'
  workflow_dispatch:

jobs:
  anomaly-detection:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          python -c "import prettytable; print('âœ… prettytable installed:', prettytable.__version__)"

      - name: ğŸš€ Run Anomaly Detection Script
        run: |
          echo "ğŸ” Running anomaly detection..."
          python detect.py || { echo 'âŒ Anomaly detection script failed!' >&2; exit 1; }

      - name: ğŸ“„ Ensure anomaly_report.md exists
        run: |
          if [ ! -f anomaly_report.md ]; then
            echo "Anomaly Report" > anomaly_report.md
            echo "=================" >> anomaly_report.md
          fi

      - name: ğŸ•’ Capture timestamps
        id: timestamps
        run: |
          echo "LAST_MODIFIED=$(stat --format=%Y anomaly_report.md || echo 0)" >> $GITHUB_ENV
          echo "CURRENT_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ“ Append anomalies and fail on detection
        run: |
          echo "Anomalies detected at $(date)" >> anomaly_report.md
          echo "-----------------------------" >> anomaly_report.md
          python detect.py >> anomaly_report.md || {
            echo "âŒ Anomaly detection failed again!" >&2
            exit 1
          }

          if [ "$LAST_MODIFIED" -lt "$CURRENT_TIME" ]; then
            echo "â— Anomalies detected â€” failing the pipeline"
            cat anomaly_report.md
            exit 1
          else
            echo "âœ… No new anomalies found"
          fi

      - name: ğŸ©º Run Auto-Remediation Suggestions
        run: |
          echo "ğŸ”§ Checking remediation suggestions..."
          python remediate.py || echo "âš ï¸ Skipping remediation â€” no anomaly_report.csv found."

      - name: ğŸ§¾ Show anomaly report
        run: |
          echo "ğŸ“ Final Report:"
          if [ -f anomaly_report.md ]; then
            cat anomaly_report.md
          else
            echo "No anomaly report found. âœ…"
          fi
